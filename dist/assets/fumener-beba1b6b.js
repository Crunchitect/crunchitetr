var W=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},E={},y={},L={};(function(r){Object.defineProperty(r,"__esModule",{value:!0}),r.parseRotation=r.parseRotationName=r.Rotation=r.parsePiece=r.parsePieceName=r.isMinoPiece=r.Piece=void 0;var e;(function(i){i[i.Empty=0]="Empty",i[i.I=1]="I",i[i.L=2]="L",i[i.O=3]="O",i[i.Z=4]="Z",i[i.T=5]="T",i[i.J=6]="J",i[i.S=7]="S",i[i.Gray=8]="Gray"})(e=r.Piece||(r.Piece={}));function t(i){return i!==e.Empty&&i!==e.Gray}r.isMinoPiece=t;function n(i){switch(i){case e.I:return"I";case e.L:return"L";case e.O:return"O";case e.Z:return"Z";case e.T:return"T";case e.J:return"J";case e.S:return"S";case e.Gray:return"X";case e.Empty:return"_"}throw new Error("Unknown piece: ".concat(i))}r.parsePieceName=n;function o(i){switch(i.toUpperCase()){case"I":return e.I;case"L":return e.L;case"O":return e.O;case"Z":return e.Z;case"T":return e.T;case"J":return e.J;case"S":return e.S;case"X":case"GRAY":return e.Gray;case" ":case"_":case"EMPTY":return e.Empty}throw new Error("Unknown piece: ".concat(i))}r.parsePiece=o;var c;(function(i){i[i.Spawn=0]="Spawn",i[i.Right=1]="Right",i[i.Reverse=2]="Reverse",i[i.Left=3]="Left"})(c=r.Rotation||(r.Rotation={}));function h(i){switch(i){case c.Spawn:return"spawn";case c.Left:return"left";case c.Right:return"right";case c.Reverse:return"reverse"}throw new Error("Unknown rotation: ".concat(i))}r.parseRotationName=h;function s(i){switch(i.toLowerCase()){case"spawn":return c.Spawn;case"left":return c.Left;case"right":return c.Right;case"reverse":return c.Reverse}throw new Error("Unknown rotation: ".concat(i))}r.parseRotation=s})(L);Object.defineProperty(y,"__esModule",{value:!0});y.getPieces=y.getBlocks=y.getBlockXYs=y.getBlockPositions=y.PlayField=y.InnerField=y.createInnerField=y.createNewInnerField=void 0;var g=L,v={Width:10,Height:23,PlayBlocks:23*10};function Me(){return new K({})}y.createNewInnerField=Me;function Oe(r){for(var e=new K({}),t=-1;t<v.Height;t+=1)for(var n=0;n<v.Width;n+=1){var o=r.at(n,t);e.setNumberAt(n,t,(0,g.parsePiece)(o))}return e}y.createInnerField=Oe;var K=function(){function r(e){var t=e.field,n=t===void 0?r.create(v.PlayBlocks):t,o=e.garbage,c=o===void 0?r.create(v.Width):o;this.field=n,this.garbage=c}return r.create=function(e){return new pe({length:e})},r.prototype.fill=function(e){this.field.fill(e)},r.prototype.fillAll=function(e,t){this.field.fillAll(e,t)},r.prototype.canFill=function(e,t,n,o){var c=this,h=ve(e,t,n,o);return h.every(function(s){var i=s[0],a=s[1];return 0<=i&&i<10&&0<=a&&a<v.Height&&c.getNumberAt(i,a)===g.Piece.Empty})},r.prototype.canFillAll=function(e){var t=this;return e.every(function(n){var o=n.x,c=n.y;return 0<=o&&o<10&&0<=c&&c<v.Height&&t.getNumberAt(o,c)===g.Piece.Empty})},r.prototype.isOnGround=function(e,t,n,o){return!this.canFill(e,t,n,o-1)},r.prototype.clearLine=function(){this.field.clearLine()},r.prototype.riseGarbage=function(){this.field.up(this.garbage),this.garbage.clearAll()},r.prototype.mirror=function(){this.field.mirror()},r.prototype.shiftToLeft=function(){this.field.shiftToLeft()},r.prototype.shiftToRight=function(){this.field.shiftToRight()},r.prototype.shiftToUp=function(){this.field.shiftToUp()},r.prototype.shiftToBottom=function(){this.field.shiftToBottom()},r.prototype.copy=function(){return new r({field:this.field.copy(),garbage:this.garbage.copy()})},r.prototype.equals=function(e){return this.field.equals(e.field)&&this.garbage.equals(e.garbage)},r.prototype.addNumber=function(e,t,n){0<=t?this.field.addOffset(e,t,n):this.garbage.addOffset(e,-(t+1),n)},r.prototype.setNumberFieldAt=function(e,t){this.field.setAt(e,t)},r.prototype.setNumberGarbageAt=function(e,t){this.garbage.setAt(e,t)},r.prototype.setNumberAt=function(e,t,n){return 0<=t?this.field.set(e,t,n):this.garbage.set(e,-(t+1),n)},r.prototype.getNumberAt=function(e,t){return 0<=t?this.field.get(e,t):this.garbage.get(e,-(t+1))},r.prototype.getNumberAtIndex=function(e,t){return t?this.getNumberAt(e%10,Math.floor(e/10)):this.getNumberAt(e%10,-(Math.floor(e/10)+1))},r.prototype.toFieldNumberArray=function(){return this.field.toArray()},r.prototype.toGarbageNumberArray=function(){return this.garbage.toArray()},r}();y.InnerField=K;var pe=function(){function r(e){var t=e.pieces,n=e.length,o=n===void 0?v.PlayBlocks:n;t!==void 0?this.pieces=t:this.pieces=Array.from({length:o}).map(function(){return g.Piece.Empty}),this.length=o}return r.load=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.join("").trim();return r.loadInner(n)},r.loadMinify=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var n=e.join("").trim();return r.loadInner(n,n.length)},r.loadInner=function(e,t){var n=t!==void 0?t:e.length;if(n%10!==0)throw new Error("Num of blocks in field should be mod 10");for(var o=t!==void 0?new r({length:t}):new r({}),c=0;c<n;c+=1){var h=e[c];o.set(c%10,Math.floor((n-c-1)/10),(0,g.parsePiece)(h))}return o},r.prototype.get=function(e,t){return this.pieces[e+t*v.Width]},r.prototype.addOffset=function(e,t,n){this.pieces[e+t*v.Width]+=n},r.prototype.set=function(e,t,n){this.setAt(e+t*v.Width,n)},r.prototype.setAt=function(e,t){this.pieces[e]=t},r.prototype.fill=function(e){for(var t=e.type,n=e.rotation,o=e.x,c=e.y,h=C(t,n),s=0,i=h;s<i.length;s++){var a=i[s],u=[o+a[0],c+a[1]],l=u[0],p=u[1];this.set(l,p,t)}},r.prototype.fillAll=function(e,t){for(var n=0,o=e;n<o.length;n++){var c=o[n],h=c.x,s=c.y;this.set(h,s,t)}},r.prototype.clearLine=function(){for(var e=this.pieces.concat(),t=this.pieces.length/v.Width-1,n=t;0<=n;n-=1){var o=this.pieces.slice(n*v.Width,(n+1)*v.Width),c=o.every(function(i){return i!==g.Piece.Empty});if(c){var h=e.slice(0,n*v.Width),s=e.slice((n+1)*v.Width);e=h.concat(s,Array.from({length:v.Width}).map(function(){return g.Piece.Empty}))}}this.pieces=e},r.prototype.up=function(e){this.pieces=e.pieces.concat(this.pieces).slice(0,this.length)},r.prototype.mirror=function(){for(var e=[],t=0;t<this.pieces.length;t+=1){var n=this.pieces.slice(t*v.Width,(t+1)*v.Width);n.reverse();for(var o=0,c=n;o<c.length;o++){var h=c[o];e.push(h)}}this.pieces=e},r.prototype.shiftToLeft=function(){for(var e=this.pieces.length/10,t=0;t<e;t+=1){for(var n=0;n<v.Width-1;n+=1)this.pieces[n+t*v.Width]=this.pieces[n+1+t*v.Width];this.pieces[9+t*v.Width]=g.Piece.Empty}},r.prototype.shiftToRight=function(){for(var e=this.pieces.length/10,t=0;t<e;t+=1){for(var n=v.Width-1;1<=n;n-=1)this.pieces[n+t*v.Width]=this.pieces[n-1+t*v.Width];this.pieces[t*v.Width]=g.Piece.Empty}},r.prototype.shiftToUp=function(){var e=Array.from({length:10}).map(function(){return g.Piece.Empty});this.pieces=e.concat(this.pieces).slice(0,this.length)},r.prototype.shiftToBottom=function(){var e=Array.from({length:10}).map(function(){return g.Piece.Empty});this.pieces=this.pieces.slice(10,this.length).concat(e)},r.prototype.toArray=function(){return this.pieces.concat()},Object.defineProperty(r.prototype,"numOfBlocks",{get:function(){return this.pieces.length},enumerable:!1,configurable:!0}),r.prototype.copy=function(){return new r({pieces:this.pieces.concat(),length:this.length})},r.prototype.toShallowArray=function(){return this.pieces},r.prototype.clearAll=function(){this.pieces=this.pieces.map(function(){return g.Piece.Empty})},r.prototype.equals=function(e){if(this.pieces.length!==e.pieces.length)return!1;for(var t=0;t<this.pieces.length;t+=1)if(this.pieces[t]!==e.pieces[t])return!1;return!0},r}();y.PlayField=pe;function ve(r,e,t,n){return C(r,e).map(function(o){return o[0]+=t,o[1]+=n,o})}y.getBlockPositions=ve;function Le(r,e,t,n){return C(r,e).map(function(o){return{x:o[0]+t,y:o[1]+n}})}y.getBlockXYs=Le;function C(r,e){var t=ge(r);switch(e){case g.Rotation.Spawn:return t;case g.Rotation.Left:return qe(t);case g.Rotation.Reverse:return Se(t);case g.Rotation.Right:return Ie(t)}throw new Error("Unsupported block")}y.getBlocks=C;function ge(r){switch(r){case g.Piece.I:return[[0,0],[-1,0],[1,0],[2,0]];case g.Piece.T:return[[0,0],[-1,0],[1,0],[0,1]];case g.Piece.O:return[[0,0],[1,0],[0,1],[1,1]];case g.Piece.L:return[[0,0],[-1,0],[1,0],[1,1]];case g.Piece.J:return[[0,0],[-1,0],[1,0],[-1,1]];case g.Piece.S:return[[0,0],[-1,0],[0,1],[1,1]];case g.Piece.Z:return[[0,0],[1,0],[0,1],[-1,1]]}throw new Error("Unsupported rotation")}y.getPieces=ge;function Ie(r){return r.map(function(e){return[e[1],-e[0]]})}function qe(r){return r.map(function(e){return[-e[1],e[0]]})}function Se(r){return r.map(function(e){return[-e[0],-e[1]]})}var Q={};Object.defineProperty(Q,"__esModule",{value:!0});Q.Buffer=void 0;var ee="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",ke=function(){function r(e){e===void 0&&(e=""),this.values=e.split("").map(Ne)}return r.prototype.poll=function(e){for(var t=0,n=0;n<e;n+=1){var o=this.values.shift();if(o===void 0)throw new Error("Unexpected fumen");t+=o*Math.pow(r.tableLength,n)}return t},r.prototype.push=function(e,t){t===void 0&&(t=1);for(var n=e,o=0;o<t;o+=1)this.values.push(n%r.tableLength),n=Math.floor(n/r.tableLength)},r.prototype.merge=function(e){for(var t=0,n=e.values;t<n.length;t++){var o=n[t];this.values.push(o)}},r.prototype.isEmpty=function(){return this.values.length===0},Object.defineProperty(r.prototype,"length",{get:function(){return this.values.length},enumerable:!1,configurable:!0}),r.prototype.get=function(e){return this.values[e]},r.prototype.set=function(e,t){this.values[e]=t},r.prototype.toString=function(){return this.values.map(_e).join("")},r.tableLength=ee.length,r}();Q.Buffer=ke;function Ne(r){return ee.indexOf(r)}function _e(r){return ee[r]}var M={},B=W&&W.__assign||function(){return B=Object.assign||function(r){for(var e,t=1,n=arguments.length;t<n;t++){e=arguments[t];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o])}return r},B.apply(this,arguments)};Object.defineProperty(M,"__esModule",{value:!0});M.createActionEncoder=M.createActionDecoder=void 0;var f=L;function I(r){return r!==0}var Fe=function(r,e,t){var n=e+t,o=n*r;function c(i){switch(i){case 0:return f.Piece.Empty;case 1:return f.Piece.I;case 2:return f.Piece.L;case 3:return f.Piece.O;case 4:return f.Piece.Z;case 5:return f.Piece.T;case 6:return f.Piece.J;case 7:return f.Piece.S;case 8:return f.Piece.Gray}throw new Error("Unexpected piece")}function h(i){switch(i){case 0:return f.Rotation.Reverse;case 1:return f.Rotation.Right;case 2:return f.Rotation.Spawn;case 3:return f.Rotation.Left}throw new Error("Unexpected rotation")}function s(i,a,u){var l=i%r,p=Math.floor(i/10),m=e-p-1;return a===f.Piece.O&&u===f.Rotation.Left?(l+=1,m-=1):a===f.Piece.O&&u===f.Rotation.Reverse?l+=1:a===f.Piece.O&&u===f.Rotation.Spawn?m-=1:a===f.Piece.I&&u===f.Rotation.Reverse?l+=1:a===f.Piece.I&&u===f.Rotation.Left||a===f.Piece.S&&u===f.Rotation.Spawn?m-=1:a===f.Piece.S&&u===f.Rotation.Right?l-=1:a===f.Piece.Z&&u===f.Rotation.Spawn?m-=1:a===f.Piece.Z&&u===f.Rotation.Left&&(l+=1),{x:l,y:m}}return{decode:function(i){var a=i,u=c(a%8);a=Math.floor(a/8);var l=h(a%4);a=Math.floor(a/4);var p=s(a%o,u,l);a=Math.floor(a/o);var m=I(a%2);a=Math.floor(a/2);var d=I(a%2);a=Math.floor(a/2);var b=I(a%2);a=Math.floor(a/2);var N=I(a%2);a=Math.floor(a/2);var _=!I(a%2);return{rise:m,mirror:d,colorize:b,comment:N,lock:_,piece:B(B({},p),{type:u,rotation:l})}}}};M.createActionDecoder=Fe;function q(r){return r?1:0}var ze=function(r,e,t){var n=e+t,o=n*r;function c(s){var i=s.type,a=s.rotation,u=s.x,l=s.y;return(0,f.isMinoPiece)(i)?i===f.Piece.O&&a===f.Rotation.Left?(u-=1,l+=1):i===f.Piece.O&&a===f.Rotation.Reverse?u-=1:i===f.Piece.O&&a===f.Rotation.Spawn?l+=1:i===f.Piece.I&&a===f.Rotation.Reverse?u-=1:i===f.Piece.I&&a===f.Rotation.Left||i===f.Piece.S&&a===f.Rotation.Spawn?l+=1:i===f.Piece.S&&a===f.Rotation.Right?u+=1:i===f.Piece.Z&&a===f.Rotation.Spawn?l+=1:i===f.Piece.Z&&a===f.Rotation.Left&&(u-=1):(u=0,l=22),(e-l-1)*r+u}function h(s){var i=s.type,a=s.rotation;if(!(0,f.isMinoPiece)(i))return 0;switch(a){case f.Rotation.Reverse:return 0;case f.Rotation.Right:return 1;case f.Rotation.Spawn:return 2;case f.Rotation.Left:return 3}throw new Error("No reachable")}return{encode:function(s){var i=s.lock,a=s.comment,u=s.colorize,l=s.mirror,p=s.rise,m=s.piece,d=q(!i);return d*=2,d+=q(a),d*=2,d+=q(u),d*=2,d+=q(l),d*=2,d+=q(p),d*=o,d+=c(m),d*=4,d+=h(m),d*=8,d+=m.type,d}}};M.createActionEncoder=ze;var j={};Object.defineProperty(j,"__esModule",{value:!0});j.createCommentParser=void 0;var Y=" !\"#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[\\]^_`abcdefghijklmnopqrstuvwxyz{|}~",H=Y.length+1,We=function(){return{decode:function(r){for(var e="",t=r,n=0;n<4;n+=1){var o=t%H;e+=Y[o],t=Math.floor(t/H)}return e},encode:function(r,e){return Y.indexOf(r)*Math.pow(H,e)}}};j.createCommentParser=We;var U={};Object.defineProperty(U,"__esModule",{value:!0});U.Quiz=void 0;var P=L,w;(function(r){r.Direct="direct",r.Swap="swap",r.Stock="stock"})(w||(w={}));var Be=function(){function r(e){this.quiz=r.verify(e)}return Object.defineProperty(r.prototype,"next",{get:function(){var e=this.quiz.indexOf(")")+1,t=this.quiz[e];return t===void 0||t===";"?"":t},enumerable:!1,configurable:!0}),r.isQuizComment=function(e){return e.startsWith("#Q=")},r.create=function(e,t){var n=function(o,c){var h=function(s){return s||""};return new r("#Q=[".concat(h(o),"](").concat(h(c[0]),")").concat(h(c.substring(1))))};return t!==void 0?n(e,t):n(void 0,e)},r.trim=function(e){return e.trim().replace(/\s+/g,"")},Object.defineProperty(r.prototype,"least",{get:function(){var e=this.quiz.indexOf(")");return this.quiz.substr(e+1)},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"current",{get:function(){var e=this.quiz.indexOf("(")+1,t=this.quiz[e];return t===")"?"":t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"hold",{get:function(){var e=this.quiz.indexOf("[")+1,t=this.quiz[e];return t==="]"?"":t},enumerable:!1,configurable:!0}),Object.defineProperty(r.prototype,"leastAfterNext2",{get:function(){var e=this.quiz.indexOf(")");return this.quiz[e+1]===";"?this.quiz.substr(e+1):this.quiz.substr(e+2)},enumerable:!1,configurable:!0}),r.prototype.getOperation=function(e){var t=(0,P.parsePieceName)(e),n=this.current;if(t===n)return w.Direct;var o=this.hold;if(t===o)return w.Swap;if(o===""){if(t===this.next)return w.Stock}else if(n===""&&t===this.next)return w.Direct;throw new Error("Unexpected hold piece in quiz: ".concat(this.quiz))},Object.defineProperty(r.prototype,"leastInActiveBag",{get:function(){var e=this.quiz.indexOf(";"),t=0<=e?this.quiz.substring(0,e):this.quiz,n=t.indexOf(")");return t[n+1]===";"?t.substr(n+1):t.substr(n+2)},enumerable:!1,configurable:!0}),r.verify=function(e){var t=this.trim(e);if(t.length===0||e==="#Q=[]()"||!e.startsWith("#Q="))return e;if(!t.match(/^#Q=\[[TIOSZJL]?]\([TIOSZJL]?\)[TIOSZJL]*;?.*$/i))throw new Error("Current piece doesn't exist, however next pieces exist: ".concat(e));return t},r.prototype.direct=function(){if(this.current===""){var e=this.leastAfterNext2;return new r("#Q=[".concat(this.hold,"](").concat(e[0],")").concat(e.substr(1)))}return new r("#Q=[".concat(this.hold,"](").concat(this.next,")").concat(this.leastAfterNext2))},r.prototype.swap=function(){if(this.hold==="")throw new Error("Cannot find hold piece: ".concat(this.quiz));var e=this.next;return new r("#Q=[".concat(this.current,"](").concat(e,")").concat(this.leastAfterNext2))},r.prototype.stock=function(){if(this.hold!==""||this.next==="")throw new Error("Cannot stock: ".concat(this.quiz));var e=this.leastAfterNext2,t=e[0]!==void 0?e[0]:"";return 1<e.length?new r("#Q=[".concat(this.current,"](").concat(t,")").concat(e.substr(1))):new r("#Q=[".concat(this.current,"](").concat(t,")"))},r.prototype.operate=function(e){switch(e){case w.Direct:return this.direct();case w.Swap:return this.swap();case w.Stock:return this.stock()}throw new Error("Unexpected operation")},r.prototype.format=function(){var e=this.nextIfEnd();if(e.quiz==="#Q=[]()")return new r("");var t=e.current,n=e.hold;if(t===""&&n!=="")return new r("#Q=[](".concat(n,")").concat(e.least));if(t===""){var o=e.least,c=o[0];return c===void 0?new r(""):c===";"?new r(o.substr(1)):new r("#Q=[](".concat(c,")").concat(o.substr(1)))}return e},r.prototype.getHoldPiece=function(){if(!this.canOperate())return P.Piece.Empty;var e=this.hold;return e===void 0||e===""||e===";"?P.Piece.Empty:(0,P.parsePiece)(e)},r.prototype.getNextPieces=function(e){if(!this.canOperate())return e!==void 0?Array.from({length:e}).map(function(){return P.Piece.Empty}):[];var t=(this.current+this.next+this.leastInActiveBag).substr(0,e);return e!==void 0&&t.length<e&&(t+=" ".repeat(e-t.length)),t.split("").map(function(n){return n===void 0||n===" "||n===";"?P.Piece.Empty:(0,P.parsePiece)(n)})},r.prototype.toString=function(){return this.quiz},r.prototype.canOperate=function(){var e=this.quiz;return e.startsWith("#Q=[]();")&&(e=this.quiz.substr(8)),e.startsWith("#Q=")&&e!=="#Q=[]()"},r.prototype.nextIfEnd=function(){return this.quiz.startsWith("#Q=[]();")?new r(this.quiz.substr(8)):this},r}();U.Quiz=Be;var O={},T=W&&W.__assign||function(){return T=Object.assign||function(r){for(var e,t=1,n=arguments.length;t<n;t++){e=arguments[t];for(var o in e)Object.prototype.hasOwnProperty.call(e,o)&&(r[o]=e[o])}return r},T.apply(this,arguments)};Object.defineProperty(O,"__esModule",{value:!0});O.Mino=O.Field=void 0;var z=y,R=L;function X(r){return r instanceof $?r.copy():$.from(r)}var Te=function(){function r(e){this.field=e}return r.create=function(e,t){return new r(new z.InnerField({field:e!==void 0?z.PlayField.load(e):void 0,garbage:t!==void 0?z.PlayField.loadMinify(t):void 0}))},r.prototype.canFill=function(e){if(e===void 0)return!0;var t=X(e);return this.field.canFillAll(t.positions())},r.prototype.canLock=function(e){return e===void 0?!0:this.canFill(e)?!this.canFill(T(T({},e),{y:e.y-1})):!1},r.prototype.fill=function(e,t){if(t===void 0&&(t=!1),e!==void 0){var n=X(e);if(!t&&!this.canFill(n))throw Error("Cannot fill piece on field");return this.field.fillAll(n.positions(),(0,R.parsePiece)(n.type)),n}},r.prototype.put=function(e){if(e!==void 0){for(var t=X(e);0<=t.y;t.y-=1)if(this.canLock(t))return this.fill(t),t;throw Error("Cannot put piece on field")}},r.prototype.clearLine=function(){this.field.clearLine()},r.prototype.at=function(e,t){return(0,R.parsePieceName)(this.field.getNumberAt(e,t))},r.prototype.set=function(e,t,n){this.field.setNumberAt(e,t,(0,R.parsePiece)(n))},r.prototype.copy=function(){return new r(this.field.copy())},r.prototype.str=function(e){e===void 0&&(e={});for(var t=e.reduced!==void 0?e.reduced:!0,n=e.separator!==void 0?e.separator:`
`,o=e.garbage===void 0||e.garbage?-1:0,c="",h=22;o<=h;h-=1){for(var s="",i=0;i<10;i+=1)s+=this.at(i,h);t&&s==="__________"||(t=!1,c+=s,h!==o&&(c+=n))}return c},r}();O.Field=Te;var $=function(){function r(e,t,n,o){this.type=e,this.rotation=t,this.x=n,this.y=o}return r.from=function(e){return new r(e.type,e.rotation,e.x,e.y)},r.prototype.positions=function(){return(0,z.getBlockXYs)((0,R.parsePiece)(this.type),(0,R.parseRotation)(this.rotation),this.x,this.y).sort(function(e,t){return e.y===t.y?e.x-t.x:e.y-t.y})},r.prototype.operation=function(){return{type:this.type,rotation:this.rotation,x:this.x,y:this.y}},r.prototype.isValid=function(){try{(0,R.parsePiece)(this.type),(0,R.parseRotation)(this.rotation)}catch{return!1}return this.positions().every(function(e){var t=e.x,n=e.y;return 0<=t&&t<10&&0<=n&&n<23})},r.prototype.copy=function(){return new r(this.type,this.rotation,this.x,this.y)},r}();O.Mino=$;Object.defineProperty(E,"__esModule",{value:!0});var ye=E.decode=E.extract=E.Page=void 0,me=y,Ce=Q,S=L,Qe=M,je=j,he=U,V=O,be=function(){function r(e,t,n,o,c,h){this.index=e,this.operation=n,this.comment=o,this.flags=c,this.refs=h,this._field=t.copy()}return Object.defineProperty(r.prototype,"field",{get:function(){return new V.Field(this._field.copy())},set:function(e){this._field=(0,me.createInnerField)(e)},enumerable:!1,configurable:!0}),r.prototype.mino=function(){return V.Mino.from(this.operation)},r}();E.Page=be;var x={GarbageLine:1,Width:10};function we(r){var e=function(h,s){var i=s.trim().replace(/[?\s]+/g,"");return{version:h,data:i}},t=r,n=t.indexOf("&");0<=n&&(t=t.substring(0,n));{var o=r.match(/[vmd]115@/);if(o!=null&&o.index!==void 0){var c=t.substr(o.index+5);return e("115",c)}}{var o=r.match(/[vmd]110@/);if(o!=null&&o.index!==void 0){var c=t.substr(o.index+5);return e("110",c)}}throw new Error("Unsupported fumen version")}E.extract=we;function Ue(r){var e=we(r),t=e.version,n=e.data;switch(t){case"115":return de(n,23);case"110":return de(n,21)}throw new Error("Unsupported fumen version")}ye=E.decode=Ue;function de(r,e){for(var t=e+x.GarbageLine,n=t*x.Width,o=new Ce.Buffer(r),c=function(D){for(var J={changed:!0,field:D},F=0;F<n;){var fe=o.poll(2),se=Math.floor(fe/n),ue=fe%n;se===8&&ue===n-1&&(J.changed=!1);for(var le=0;le<ue+1;le+=1){var Ae=F%x.Width,xe=e-Math.floor(F/x.Width)-1;J.field.addNumber(Ae,xe,se-8),F+=1}}return J},h=0,s=(0,me.createNewInnerField)(),i={repeatCount:-1,refIndex:{comment:0,field:0},quiz:void 0,lastCommentText:""},a=[],u=(0,Qe.createActionDecoder)(x.Width,e,x.GarbageLine),l=(0,je.createCommentParser)();!o.isEmpty();){var p=void 0;0<i.repeatCount?(p={field:s,changed:!1},i.repeatCount-=1):(p=c(s.copy()),p.changed||(i.repeatCount=o.poll(1)));var m=o.poll(3),d=u.decode(m),b=void 0;if(d.comment){for(var N=[],_=o.poll(2),te=0;te<Math.floor((_+3)/4);te+=1){var Pe=o.poll(5);N.push(Pe)}for(var re="",G=0,ne=N;G<ne.length;G++){var Re=ne[G];re+=l.decode(Re)}var ie=unescape(re.slice(0,_));i.lastCommentText=ie,b={text:ie},i.refIndex.comment=h;var oe=b.text;if(he.Quiz.isQuizComment(oe))try{i.quiz=new he.Quiz(oe)}catch{i.quiz=void 0}else i.quiz=void 0}else h===0?b={text:""}:b={text:i.quiz!==void 0?i.quiz.format().toString():void 0,ref:i.refIndex.comment};var ae=!1;if(i.quiz!==void 0&&(ae=!0,i.quiz.canOperate()&&d.lock))if((0,S.isMinoPiece)(d.piece.type))try{var ce=i.quiz.nextIfEnd(),Ee=ce.getOperation(d.piece.type);i.quiz=ce.operate(Ee)}catch{i.quiz=i.quiz.format()}else i.quiz=i.quiz.format();var A=void 0;d.piece.type!==S.Piece.Empty&&(A=d.piece);var Z=void 0;p.changed||h===0?(Z={},i.refIndex.field=h):Z={ref:i.refIndex.field},a.push(new be(h,p.field,A!==void 0?V.Mino.from({type:(0,S.parsePieceName)(A.type),rotation:(0,S.parseRotationName)(A.rotation),x:A.x,y:A.y}):void 0,b.text!==void 0?b.text:i.lastCommentText,{quiz:ae,lock:d.lock,mirror:d.mirror,colorize:d.colorize,rise:d.rise},{field:Z.ref,comment:b.ref})),h+=1,d.lock&&((0,S.isMinoPiece)(d.piece.type)&&p.field.fill(d.piece),p.field.clearLine(),d.rise&&p.field.riseGarbage(),d.mirror&&p.field.mirror()),s=p.field}return a}const k={I:{normal:"#41afde",highlight1:"#3dc0fb",highlight2:"#3dc0fb",lighter:"#3dc0fb",light:"#43d3ff"},T:{normal:"#b451ac",highlight1:"#d161c9",highlight2:"#d161c9",lighter:"#d161c9",light:"#e56add"},S:{normal:"#66c65c",highlight1:"#75d96a",highlight2:"#7cd97a",lighter:"#7cd97a",light:"#88ee86"},Z:{normal:"#ef624d",highlight1:"#ff7866",highlight2:"#ff8778",lighter:"#fd7660",light:"#ff9484"},L:{normal:"#ef9535",highlight1:"#ffa94d",highlight2:"#ffae58",lighter:"#fea440",light:"#ffbf60"},J:{normal:"#1983bf",highlight1:"#1997e3",highlight2:"#1997e3",lighter:"#1997e3",light:"#1ba6f9"},O:{normal:"#f7d33e",highlight1:"#ffe34b",highlight2:"#ffe34b",lighter:"#ffe34b",light:"#fff952"},X:{normal:"#686868",highlight1:"#686868",highlight2:"#686868",lighter:"#686868",light:"#949494"},Empty:{normal:"#f3f3ed"}};function Ge(r,e,t,n){const o=r.field,c=r.operation;if(t==null){t=0;for(let u=0;u<10;u++)for(let l=0;l<23;l++)o.at(u,l)!="_"&&(t=Math.max(t,l)),c!=null&&c.positions().filter(p=>u==p.x&&l==p.y).length>0&&(t=Math.max(t,l));t+=2}const h=e*10,s=t*e,i=document.createElement("canvas");i.width=h,i.height=s;const a=i.getContext("2d");n?a.fillStyle="rgba(0, 0, 0, 0)":a.fillStyle=k.Empty.normal,a.fillRect(0,0,h,s);for(let u=0;u<10;u++)for(let l=0;l<t;l++)o.at(u,l)!="_"&&(a.fillStyle=k[o.at(u,l)].light,a.fillRect(u*e,s-(l+1)*e-e/5,e,e+e/5)),c!=null&&c.positions().filter(p=>u==p.x&&l==p.y).length>0&&(a.fillStyle=k[c.type].light,a.fillRect(u*e,s-(l+1)*e-e/5,e,e+e/5));for(let u=0;u<10;u++)for(let l=0;l<t;l++)o.at(u,l)!="_"&&(a.fillStyle=k[o.at(u,l)].normal,a.fillRect(u*e,s-(l+1)*e,e,e)),c!=null&&c.positions().filter(p=>u==p.x&&l==p.y).length>0&&(a.fillStyle=k[c.type].normal,a.fillRect(u*e,s-(l+1)*e,e,e));return i}function Ze(r){return Ge(ye(r)[0],22,void 0,!0)}export{Ze as f};
